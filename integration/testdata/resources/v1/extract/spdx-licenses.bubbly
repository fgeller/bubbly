resource "extract" "spdx_list" {
    api_version = "v1"

    spec {
        input url {}
        type = "rest"

        source {
            url = self.input.url
            decoder = "json"
            
            headers = {
                "Accept": "application/vnd.github.v3+json"
            }
            timeout = 5

            format = object({
                licenseListVersion: string,
                licenses: list(object({
                    reference: string,
                    isDeprecatedLicenseId: bool,
                    detailsUrl: string,
                    referenceNumber: string,
                    name: string,
                    licenseId: string,
                    seeAlso: list(string),
                    isOsiApproved: bool
                })),
                releaseDate: string
            })
        }
    }
}

resource "extract" "spdx_licenses" {
    api_version = "v1"
    
    spec {
        input spdx_list {}
        type = "rest"

        dynamic "source" {
        
            for_each = slice(self.input.spdx_list.licenses, 0, 5)
            iterator = it

            content {
                url = it.value.detailsUrl
                #decoder, actually, is an optional argument)
                #decoder = "json"
                timeout = 5

                # Notes:
                #   * match field is actually boolean in a string: "true"/"false".
                #   * isFsfLibre field is absent in some records.
                #
                format = object({
                    isDeprecatedLicenseId: bool,
                    isFsfLibre: bool,
                    licenseText: string,
                    name: string,
                    licenseId: string,
                    crossRef: list(object({
                        isLive: bool,
                        isValid: bool,
                        isWayBackLink: bool,
                        match: string,
                        url: string,
                        order: number,
                        timestamp: string
                    })),
                    seeAlso: list(string),
                    isOsiApproved: bool
                })
            }
        }
    }
}

resource "transform" "license_data" {
    api_version = "v1"

    spec {
        input "spdx_licenses" {}

        dynamic "data" {
            for_each = self.input.spdx_licenses
            iterator = it
            labels = ["spdx_license"]
            content {
                fields = {
                    "id": it.value.licenseId
                    "name": it.value.name
                    "crossref_count": length(it.value.crossRef)
                }
            }
        }
    }
}

resource "load" "upload_license_data" {
    api_version = "v1"

    spec {
        input "data" {}
        data = self.input.data
    }
}

resource "pipeline" "licenses" {
    api_version = "v1"

    spec {

        task "extract_spdx_list" {
            resource = "extract/spdx_list"
            input "url" {
                # TODO: update from tag v3.7 to master after failure handlers had been added to extract
                value = "https://raw.githubusercontent.com/spdx/license-list-data/v3.5/json/licenses.json"
            }
        }

        task "extract_spdx_licenses" {
            resource = "extract/spdx_licenses"
            input "spdx_list" {
                value = self.task.extract_spdx_list.value
            }
        }

        task "transform_license_data" {
            resource = "transform/license_data"
            input "spdx_licenses" {
                value = self.task.extract_spdx_licenses.value
            }
        }

        task "load" {
            resource = "load/upload_license_data"
            input "data" {
                value = self.task.transform_license_data.value
            }
        }
    }
}

resource "run" "licenses" {
    api_version = "v1"
    spec {
        resource = "pipeline/licenses"
    }
}
