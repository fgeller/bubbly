
resource "extract" "rest_a" {
    api_version = "v1"

    spec {
        type = "rest"

        input "url" {}

        source {
            url = self.input.url

            basic_auth {
                username = "the_mouse"
                #password = "d147dde5bb0a3f589fef03d50dfcfe446322f364"
                password_file = "./testdata/rest2/the_mouse_password"
            }

            headers = {
                "Accept": "application/vnd.github.v3+json"
            }

            params = {
                "per_page": 12
            }

            format = object({
                answer: number
            })
        }
    }
}

resource "pipeline" "rest_two" {
    api_version = "v1"

    spec {
        input "url" {}

        task "extract_rest_a" {
            resource = "extract/rest_a"

            input "url" {
                value = self.input.url
            }
        }

        # TODO Extract from second resource
        #task "extract_rest_b" {
        #    resource = "extract/rest_b"
        #
        #    input "repo" {
        #        value = self.input.repo
        #    }
        #}

        # TODO task transform
        # TODO task load
    }
}

resource "pipeline_run" "rest_merger" {
    api_version = "v1"

    spec {
        pipeline = "rest_two"

        input "url" {
            value = "https://api.cloud84.dev/users"
        }
    }
}
