
resource "importer" "sq_json" {
    api_version = "v1"
    // this is an input to the importer to make it reusable
    spec {
        input "file" {}
        type = "json"
        source {
            file = self.input.file
            format = object({
                issues: list(object({
                    engineId: string,
                    ruleId: string,
                    severity: string,
                    type: string,
                    primaryLocation: object({
                        message: string,
                        filePath: string,
                        textRange: object({
                            startLine: number,
                            endLine: number,
                            startColumn: number,
                            endColumn: number
                        })
                    })
                }))
            })
        }
    }
}


resource "translator" "sq_json" {
    api_version = "v1"
    spec {
        input "data" {}
        // this is some crazy dynamic HCL stuff to create the "data" blocks
        dynamic "data" {
            for_each = self.input.data.issues
            iterator = issue
            labels = ["test_table"]
            content {
                field "test_field" {
                    value = "This field exists in table_${issue.value.ruleId}"
                }
            }
        }
    }
}

// This is the upload step, just renamed to publish...
resource "publish" "sq_json" {
    api_version = "v1"
    spec {
        input "data" {}
        // what do we need here?!
        data = self.input.data
    }
}

// How do we tie all the above resources together...? In a pipeline!
// A pipeline is just another reusable resource, and only a pipelineRun
// actually triggers a pipeline to run
resource "pipeline" "sq_json" {
    api_version = "v1"
    spec {
        input "file" {}
        // Each task in a pipeline has an output, similar to resources,
        // so that task outputs can be referenced
        task "import" {
            resource = "importer/sq_json"
            input "file" {
                value = self.input.file
            }
        }
        task "translator" {
            resource = "translator/sq_json"
            input "data" {
                // here we reference the output of the task "importer"
                value = self.task.import.value
            }
        }
        task "publish" {
            resource = "publish/sq_json"
            input "data" {
                value = self.task.translator.value
            }
        }
    }
}

// A pipeline_run resources executes a pipeline resource.
resource "pipeline_run" "sq_json" {
    api_version = "v1"
    spec {
        // specify the name of the pipeline
        pipeline = "sq_json"
        // specify the input required
        input "file" {
            value = "../parser/testdata/local-sq-json/sonarqube-example.json"
        }
    }
}
