
// TODO: once the git extract exists
resource "extract" "git" {
    api_version = "v1"
    spec {
        input "dir" {}
        type = "git"
    }
}


resource "transform" "git" {
    api_version = "v1"
    spec {
        input "git" {}
        
        data "repository" {
            field "id" {
                value = self.input.git.name
            }
        }

        data "repository_version" {
            field "id" {
                value = self.input.git.commit_id
            }
            field "tag" {
                value = self.input.git.tag
            }
            field "branch" {
                value = self.input.git.branch
            }
            // TODO: this is currently not supported, how do we do this???
            // field "respository_id" {
            //     value self.data.repository.id
            // }
        }
    }
}

// This is the upload step, just renamed to load...
resource "load" "git" {
    api_version = "v1"
    spec {
        input "data" {}
        data = self.input.data
    }
}

resource "pipeline" "git" {
    api_version = "v1"
    spec {
        input "dir" {}
        task "extract" {
            resource = "extract/git"
            input "dir" {
                value = self.input.dir
            }
        }
        task "transform" {
            resource = "transform/git"
            input "git" {
                value = self.task.extract.value
            }
        }
        task "load" {
            resource = "load/git"
            input "data" {
                value = self.task.transform.value
            }
        }
    }
}

